@model TaskManagementMvc.Models.TaskItem

<style>
.task-card {
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid #e9ecef;
    position: relative;
    cursor: move;
    transition: all 0.2s ease;
    overflow: hidden;
}

.task-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.task-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.task-priority-stripe {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
}

.priority-low { background: #28a745; }
.priority-medium { background: #ffc107; }
.priority-high { background: #fd7e14; }
.priority-critical { background: #dc3545; }

.task-header {
    padding: 8px 12px 4px 12px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.task-id {
    color: #6c757d;
    font-size: 10px;
    font-weight: 500;
}

.task-menu {
    position: relative;
}

.task-menu-btn {
    background: none;
    border: none;
    color: #6c757d;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.task-menu-btn:hover {
    background: rgba(108, 117, 125, 0.1);
    color: #495057;
}

.task-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    background: white;
    border: 1px solid #e0e6ed;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 1000;
    min-width: 140px;
    display: none;
    overflow: hidden;
    animation: dropdownSlide 0.15s ease-out;
}

@@keyframes dropdownSlide {
    from {
        opacity: 0;
        transform: translateY(-8px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.task-dropdown.show {
    display: block;
}

.dropdown-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 8px 12px;
    color: #374151;
    text-decoration: none;
    border: none;
    background: none;
    text-align: right;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    gap: 6px;
}

.dropdown-item i {
    font-size: 14px;
    width: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dropdown-item:hover {
    background: #f8fafc;
    color: #1e293b;
}

.dropdown-item.text-danger {
    color: #dc2626;
}

.dropdown-item.text-danger:hover {
    background: #fef2f2;
    color: #b91c1c;
}

.dropdown-item.text-danger i {
    color: #dc2626;
}

.task-title {
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 4px 12px 6px 12px;
    line-height: 1.3;
}

.task-labels {
    padding: 0 12px 6px 12px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.task-label {
    background: #e3f2fd;
    color: #1565c0;
    font-size: 9px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 8px;
    text-transform: uppercase;
}

.task-progress {
    padding: 4px 12px;
}

.progress-bar-custom {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.task-footer {
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.task-stats {
    display: flex;
    gap: 8px;
    font-size: 10px;
    color: #6c757d;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 3px;
}

.task-sp {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
}
</style>

@{
    var priorityClass = Model.Priority switch
    {
        TaskManagementMvc.Models.TaskPriority.Low => "priority-low",
        TaskManagementMvc.Models.TaskPriority.Medium => "priority-medium", 
        TaskManagementMvc.Models.TaskPriority.High => "priority-high",
        TaskManagementMvc.Models.TaskPriority.Critical => "priority-critical",
        _ => "priority-medium"
    };
    
    var progressPercentage = Model.Status switch
    {
        TaskManagementMvc.Models.TaskStatus.NotStarted => 0,
        TaskManagementMvc.Models.TaskStatus.InProgress => 50,
        TaskManagementMvc.Models.TaskStatus.Completed => 100,
        _ => 0
    };
}

<div class="task-card" draggable="true" data-task-id="@Model.Id" data-assignee-id="@Model.PerformerId" title="دبل کلیک برای ویرایش">
    <div class="task-priority-stripe @priorityClass"></div>
    
    <div class="task-header">
        <span class="task-id">#@Model.Id</span>
        <div class="task-menu">
            <button class="task-menu-btn" onclick="toggleDropdown(this)" title="منو">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <div class="task-dropdown">
                <button class="dropdown-item" onclick="editTask(@Model.Id)">
                    <i class="bi bi-pencil"></i>
                    <span>ویرایش تسک</span>
                </button>
                <button class="dropdown-item" onclick="viewTask(@Model.Id)">
                    <i class="bi bi-eye"></i>
                    <span>مشاهده جزئیات</span>
                </button>
                <div style="height: 1px; background: #e5e7eb; margin: 4px 12px;"></div>
                <button class="dropdown-item text-danger" onclick="deleteTask(@Model.Id)">
                    <i class="bi bi-trash"></i>
                    <span>حذف تسک</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="task-title">@Model.Title</div>
    
    <div class="task-labels">
        <span class="task-label">@Model.Priority.ToString().ToUpper()</span>
        @if (Model.Project != null && !string.IsNullOrEmpty(Model.Project.Name))
        {
            <span class="task-label" style="background: #fff3cd; color: #856404;">@Model.Project.Name</span>
        }
    </div>
    
    <div class="task-progress">
        <div class="progress-bar-custom">
            <div class="progress-fill" style="width: @progressPercentage%"></div>
        </div>
    </div>
    
    <div class="task-footer">
        <div class="task-stats">
            <div class="stat-item">
                <i class="bi bi-clock"></i>
                <span>@(Model.OriginalEstimateHours?.ToString("0") ?? "0")ساعت</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-calendar"></i>
                <span>@Model.CreatedAt.ToString("MM/dd")</span>
            </div>
            @if (Model.Status == TaskManagementMvc.Models.TaskStatus.Completed && Model.EndAt.HasValue)
            {
                <div class="stat-item completed-date">
                    <i class="bi bi-check-circle text-success"></i>
                    <span>@Model.EndAt.Value.ToString("MM/dd")</span>
                </div>
            }
        </div>
        <div class="task-sp">@(Model.OriginalEstimateHours?.ToString("0") ?? "0") SP</div>
    </div>
</div>

<script>
function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    
    // Close all other dropdowns
    document.querySelectorAll('.task-dropdown.show').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
    });
    
    // Toggle current dropdown
    const isShowing = dropdown.classList.contains('show');
    if (isShowing) {
        dropdown.classList.remove('show');
    } else {
        dropdown.classList.add('show');
        
        // Position dropdown to ensure it's visible
        const rect = dropdown.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (rect.right > viewportWidth) {
            dropdown.style.right = '0';
            dropdown.style.left = 'auto';
        }
        
        if (rect.bottom > viewportHeight) {
            dropdown.style.top = 'auto';
            dropdown.style.bottom = '100%';
        }
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.task-menu')) {
        document.querySelectorAll('.task-dropdown.show').forEach(d => {
            d.classList.remove('show');
        });
    }
});

// Close dropdown when pressing Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.task-dropdown.show').forEach(d => {
            d.classList.remove('show');
        });
    }
});

async function deleteTask(id) {
    if (!confirm('آیا از حذف این تسک اطمینان دارید؟')) return;
    
    try {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        const formData = new FormData();
        formData.append('id', id);
        
        const response = await fetch('@Url.Action("Delete", "Tasks")', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                ...(token ? { 'RequestVerificationToken': token } : {})
            },
            body: formData
        });
        
        if (response.ok) {
            const card = document.querySelector(`[data-task-id="${id}"]`);
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.transform = 'scale(0)';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 300);
            }
            showNotification('تسک حذف شد', 'success');
        } else {
            throw new Error('Failed to delete');
        }
    } catch (error) {
        showNotification('خطا در حذف تسک', 'error');
    }
}

function viewTask(id) {
    // Navigate to task details page
    window.location.href = `@Url.Action("Details", "Tasks")/${id}`;
}
</script>
